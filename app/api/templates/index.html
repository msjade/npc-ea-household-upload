<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NPC EA Household Upload</title>
  <link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <img src="/static/img/npc_logo.jpeg" class="logo" alt="NPC Logo" />
        <div>
          <div class="title">National Population Commission</div>
          <div class="subtitle">EA Household Count Upload Portal</div>
        </div>
      </div>
    </header>

    <main class="card">
      <h1>Upload EA Household Count</h1>
      <p class="muted">
        Upload a CSV with columns: <b>NAT_EA_SN</b>, <b>HOUSEHOLD_COUNT</b>.
        You’ll see a preview and validation summary before uploading.
      </p>

      <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data" class="form">
        <div class="grid">
          <div>
            <label>Client Name</label>
            <input name="client_name" id="client_name" placeholder="e.g. UNICEF" required />
          </div>
          <div>
            <label>Client Project</label>
            <input name="client_project" id="client_project" placeholder="e.g. Baseline Survey 2026" required />
          </div>
          <div>
            <label>Date of Collection</label>
            <input type="date" name="collection_date" id="collection_date" required />
          </div>
        </div>

        <div class="upload">
          <label>CSV File</label>
          <input type="file" name="file" id="fileInput" accept=".csv" required />
          <div class="muted tiny">Tip: Export as CSV (UTF-8). Header must include NAT_EA_SN and HOUSEHOLD_COUNT.</div>
        </div>

        <!-- Preview + validation -->
        <div id="previewCard" class="preview-card" style="display:none;">
          <div class="preview-top">
            <div>
              <div class="preview-title">File Preview & Validation</div>
              <div id="fileMeta" class="muted tiny"></div>
            </div>
            <div class="chips" id="chips"></div>
          </div>

          <div id="alertBox" class="alert bad" style="display:none;"></div>

          <div class="table-wrap">
            <table class="preview-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>NAT_EA_SN</th>
                  <th>HOUSEHOLD_COUNT</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="previewBody"></tbody>
            </table>
          </div>

          <div class="muted tiny" style="margin-top:10px;">
            Showing first 20 rows only. Validation covers all rows.
          </div>
        </div>

        <button class="btn" id="submitBtn" type="submit" disabled>Upload</button>
      </form>
    </main>

    <footer class="footer">
      <span>NPC • Secure Data Upload</span>
    </footer>
  </div>

<script>
(function(){
  const fileInput = document.getElementById("fileInput");
  const previewCard = document.getElementById("previewCard");
  const previewBody = document.getElementById("previewBody");
  const submitBtn = document.getElementById("submitBtn");
  const alertBox = document.getElementById("alertBox");
  const chips = document.getElementById("chips");
  const fileMeta = document.getElementById("fileMeta");

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // Basic CSV parser with quote handling
  function parseCSV(text){
    const rows = [];
    let row = [], cur = "", inQuotes = false;

    for (let i=0; i<text.length; i++){
      const c = text[i];
      const next = text[i+1];

      if (c === '"' && inQuotes && next === '"'){ // escaped quote
        cur += '"'; i++;
      } else if (c === '"'){
        inQuotes = !inQuotes;
      } else if (c === ',' && !inQuotes){
        row.push(cur); cur = "";
      } else if ((c === '\n' || c === '\r') && !inQuotes){
        if (c === '\r' && next === '\n') i++; // CRLF
        row.push(cur); cur = "";
        // skip empty last line
        if (row.length === 1 && row[0].trim() === "") { row = []; continue; }
        rows.push(row); row = [];
      } else {
        cur += c;
      }
    }
    // last cell
    if (cur.length || row.length){
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  function setChips(stats){
    chips.innerHTML = "";
    const items = [
      ["Total rows", stats.totalRows],
      ["Valid", stats.valid],
      ["Invalid", stats.invalid],
      ["Duplicates", stats.duplicates]
    ];

    for (const [k,v] of items){
      const el = document.createElement("div");
      el.className = "chip";
      el.innerHTML = `<span class="chip-k">${escapeHtml(k)}</span><span class="chip-v">${escapeHtml(v)}</span>`;
      chips.appendChild(el);
    }
  }

  function showError(msg){
    alertBox.style.display = "block";
    alertBox.textContent = msg;
  }

  function clearError(){
    alertBox.style.display = "none";
    alertBox.textContent = "";
  }

  fileInput.addEventListener("change", async (e) => {
    submitBtn.disabled = true;
    previewBody.innerHTML = "";
    clearError();

    const file = e.target.files?.[0];
    if (!file){
      previewCard.style.display = "none";
      return;
    }

    previewCard.style.display = "block";
    fileMeta.textContent = `${file.name} • ${(file.size/1024).toFixed(1)} KB`;

    const text = await file.text();
    const table = parseCSV(text);

    if (!table.length){
      showError("Your CSV looks empty.");
      setChips({totalRows:0, valid:0, invalid:0, duplicates:0});
      return;
    }

    const header = table[0].map(h => (h ?? "").trim());
    const idxNat = header.findIndex(h => h === "NAT_EA_SN");
    const idxHH  = header.findIndex(h => h === "HOUSEHOLD_COUNT");

    if (idxNat === -1 || idxHH === -1){
      showError("Missing required columns. Header must include: NAT_EA_SN and HOUSEHOLD_COUNT.");
      setChips({totalRows:0, valid:0, invalid:0, duplicates:0});
      return;
    }

    const seen = new Set();
    let valid = 0, invalid = 0, duplicates = 0;
    const preview = [];

    // validate all rows (from line 2)
    for (let r=1; r<table.length; r++){
      const row = table[r];
      const nat = (row[idxNat] ?? "").trim();
      const hhRaw = (row[idxHH] ?? "").trim();

      let status = "OK";
      let ok = true;

      if (!nat){
        status = "Missing NAT_EA_SN";
        ok = false;
      } else if (seen.has(nat)){
        status = "Duplicate NAT_EA_SN";
        ok = false;
        duplicates++;
      } else {
        seen.add(nat);
      }

      const hh = Number(hhRaw);
      if (ok && (!Number.isFinite(hh) || !Number.isInteger(hh))){
        status = "HH must be whole number";
        ok = false;
      }
      if (ok && hh < 0){
        status = "HH cannot be negative";
        ok = false;
      }

      if (ok) valid++; else invalid++;

      if (preview.length < 20){
        preview.push({nat, hh: hhRaw, status, ok});
      }
    }

    setChips({totalRows: Math.max(0, table.length - 1), valid, invalid, duplicates});

    // render preview
    previewBody.innerHTML = preview.map((p, i) => `
      <tr>
        <td>${i+1}</td>
        <td class="mono">${escapeHtml(p.nat)}</td>
        <td class="mono">${escapeHtml(p.hh)}</td>
        <td><span class="badge ${p.ok ? "ok" : "bad"}">${escapeHtml(p.status)}</span></td>
      </tr>
    `).join("");

    if (invalid > 0){
      showError("Fix the invalid rows (and duplicates) before uploading. Upload is disabled until validation passes.");
      submitBtn.disabled = true;
      return;
    }

    // all good
    clearError();
    submitBtn.disabled = false;
  });

})();
</script>
</body>
</html>
