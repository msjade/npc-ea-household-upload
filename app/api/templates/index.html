<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NPC EA Household Upload</title>
  <link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <img src="/static/img/npc_logo.jpeg" class="logo" alt="NPC Logo" />
        <div>
          <div class="title">National Population Commission</div>
          <div class="subtitle">EA Household Count Upload Portal</div>
        </div>
      </div>
    </header>

    <main class="card">
      <h1>Upload EA Household Count</h1>
      <p class="muted">
        Upload a CSV with columns: <b>NAT_EA_SN</b>, <b>HOUSEHOLD_COUNT</b>.
        NAT_EA_SN is treated as text and duplicates are prevented.
      </p>

      <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data" class="form">
        <div class="grid">
          <div>
            <label>Client Name</label>
            <input name="client_name" placeholder="e.g. UNICEF" required />
          </div>
          <div>
            <label>Client Project</label>
            <input name="client_project" placeholder="e.g. Baseline Survey 2026" required />
          </div>
          <div>
            <label>Date of Collection</label>
            <input type="date" name="collection_date" required />
          </div>
        </div>

        <div class="upload">
          <label>CSV File</label>
          <input id="csvFile" type="file" name="file" accept=".csv" required />
          <div class="muted" style="margin-top:6px;">
            Tip: You will see a preview before upload.
          </div>
        </div>

        <!-- Preview Panel -->
        <section id="previewPanel" class="preview-panel" style="display:none;">
          <div class="preview-head">
            <div class="preview-title">Preview</div>
            <div id="previewMeta" class="preview-meta"></div>
          </div>

          <div id="previewAlert" class="preview-alert"></div>

          <div class="preview-table-wrap">
            <table class="preview-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>NAT_EA_SN</th>
                  <th>HOUSEHOLD_COUNT</th>
                </tr>
              </thead>
              <tbody id="previewBody"></tbody>
            </table>
          </div>
        </section>

        <button id="submitBtn" class="btn btn-disabled" type="submit" disabled>Upload</button>
      </form>
    </main>

    <footer class="footer">
      <span>NPC • Secure Data Upload</span>
    </footer>
  </div>

  <script>
    const fileInput = document.getElementById("csvFile");
    const previewPanel = document.getElementById("previewPanel");
    const previewMeta = document.getElementById("previewMeta");
    const previewAlert = document.getElementById("previewAlert");
    const previewBody = document.getElementById("previewBody");
    const submitBtn = document.getElementById("submitBtn");
    const uploadForm = document.getElementById("uploadForm");

    function setButtonEnabled(enabled, label) {
      submitBtn.disabled = !enabled;
      submitBtn.textContent = label || (enabled ? "Upload" : "Upload");
      if (enabled) submitBtn.classList.remove("btn-disabled");
      else submitBtn.classList.add("btn-disabled");
    }

    function setAlert(type, msg) {
      previewAlert.classList.remove("alert-ok", "alert-bad");
      if (type === "ok") previewAlert.classList.add("preview-alert", "alert-ok");
      if (type === "bad") previewAlert.classList.add("preview-alert", "alert-bad");
      previewAlert.textContent = msg;
    }

    function parseCSV(text) {
      // Simple CSV parser (handles commas + quoted values)
      const rows = [];
      let cur = "", inQuotes = false;
      const lines = [];
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];
        if (ch === '"' && next === '"') { cur += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }
        if (!inQuotes && (ch === "\n" || ch === "\r")) {
          if (ch === "\r" && next === "\n") i++;
          lines.push(cur);
          cur = "";
          continue;
        }
        cur += ch;
      }
      if (cur.length) lines.push(cur);

      for (const line of lines) {
        // split by commas not in quotes (we already removed quotes state)
        // We parse again safely:
        const out = [];
        let c = "", q = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          const next = line[i + 1];
          if (ch === '"' && next === '"') { c += '"'; i++; continue; }
          if (ch === '"') { q = !q; continue; }
          if (ch === "," && !q) { out.push(c); c = ""; continue; }
          c += ch;
        }
        out.push(c);
        rows.push(out.map(v => (v ?? "").trim()));
      }
      return rows;
    }

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      previewBody.innerHTML = "";
      previewPanel.style.display = "none";
      setButtonEnabled(false);

      if (!file) return;

      // Basic size guard (optional)
      if (file.size > 8 * 1024 * 1024) {
        previewPanel.style.display = "block";
        setAlert("bad", "File is too large for preview (max 8MB). Please reduce the file size.");
        return;
      }

      const text = await file.text();
      const rows = parseCSV(text.replace(/^\uFEFF/, "")); // remove BOM
      if (!rows.length) {
        previewPanel.style.display = "block";
        setAlert("bad", "CSV looks empty.");
        return;
      }

      const header = rows[0].map(h => (h || "").trim());
      const idxNat = header.findIndex(h => h.toUpperCase() === "NAT_EA_SN");
      const idxHh  = header.findIndex(h => h.toUpperCase() === "HOUSEHOLD_COUNT");

      previewPanel.style.display = "block";

      if (idxNat === -1 || idxHh === -1) {
        setAlert("bad", "Missing required columns. CSV must contain: NAT_EA_SN, HOUSEHOLD_COUNT.");
        previewMeta.textContent = `Detected columns: ${header.filter(Boolean).join(", ") || "(none)"}`;
        return;
      }

      const seen = new Set();
      const duplicates = [];
      let validRows = 0;
      let invalidRows = 0;

      const bodyRows = rows.slice(1).filter(r => r.length && r.some(v => (v || "").trim() !== ""));
      for (let i = 0; i < bodyRows.length; i++) {
        const r = bodyRows[i];
        const nat = (r[idxNat] || "").trim();
        const hhRaw = (r[idxHh] || "").trim();

        let hhOK = /^-?\d+$/.test(hhRaw) && parseInt(hhRaw, 10) >= 0;
        let natOK = nat.length > 0;

        if (!natOK || !hhOK) invalidRows++;
        else validRows++;

        if (natOK) {
          const key = nat;
          if (seen.has(key)) duplicates.push(nat);
          seen.add(key);
        }

        // Preview first 20
        if (i < 20) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${natOK ? nat : "<span style='color:#dc2626'>[missing]</span>"}</td>
            <td>${hhOK ? hhRaw : "<span style='color:#dc2626'>[invalid]</span>"}</td>
          `;
          previewBody.appendChild(tr);
        }
      }

      const total = bodyRows.length;
      const dupCount = duplicates.length;

      previewMeta.textContent = `${file.name} • Rows: ${total} • Showing: ${Math.min(20, total)}`;

      if (total === 0) {
        setAlert("bad", "No data rows found. Please add at least one record.");
        return;
      }

      if (invalidRows > 0) {
        setAlert("bad", `Fix ${invalidRows} invalid row(s) (missing NAT_EA_SN or invalid HOUSEHOLD_COUNT). Upload is blocked.`);
        return;
      }

      if (dupCount > 0) {
        const example = [...new Set(duplicates)].slice(0, 8).join(", ");
        setAlert("bad", `Duplicate NAT_EA_SN detected inside this CSV (${dupCount}). Example: ${example}. Upload is blocked.`);
        return;
      }

      setAlert("ok", `Looks good. ${validRows} row(s) ready to upload.`);
      setButtonEnabled(true);
    });

    uploadForm.addEventListener("submit", () => {
      // UX: prevent double click / double submit
      setButtonEnabled(false, "Uploading...");
    });
  </script>
</body>
</html>
